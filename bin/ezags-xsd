#!/usr/bin/env ruby
$:.unshift File.expand_path('../../lib', __FILE__)

require 'bundler'
Bundler.setup
require 'ezags-xsd'
require 'thor/xsd_mappers'


class CLI < Thor
  include Thor::Actions

  def initialize(*)
    super
    @script = XsdMappers::CLI.new
  end

  desc 'update_all', 'update ezags xsd mappers'
  def update_all
    update_retro
    update_order
    update_upload
    update_order_info
    replace_paths
  end

  no_tasks do
    def replace_paths
      path = File.join File.expand_path('../../app/mappers', __FILE__), '*'
      Dir[path].each do |f|
        gsub_file f, %r(schema '(vendor/ezags-protocols/.*.xsd)'$), 'schema File.expand_path(\'../../\1\', File.dirname(__FILE__))'
      end
    end

    def update_retro
      @script.generate(xsd_path 'retro/public/GetResultsService.xsd')
    end

    def update_upload
      @script.generate(xsd_path 'eZAGS/public/UploadService.xsd')
    end

    def update_order
      @script.generate(xsd_path 'eZAGS/public/OrderService.xsd')
    end

    def update_order_info
      @script.generate(xsd_path 'ePGU/order-info.xsd')
    end

    def full_path
      File.expand_path('../../vendor/ezags-protocols/', __FILE__)
    end

    def xsd_path(xsd)
      File.join 'vendor/ezags-protocols/', xsd
    end
  end

end

CLI.start
